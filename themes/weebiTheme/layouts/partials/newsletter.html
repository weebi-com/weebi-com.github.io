{{- $category := .Site.Params.newsletterCategory | default "general" -}}

<div class="newsletter-subscription" id="newsletter-subscription">
  <div class="container py-4">
    <div class="row justify-content-center">
      <div class="col-md-8 col-lg-6">
        <div class="newsletter-card rounded p-4">
          <h5 class="fw-bold mb-3">{{ T "newsletter_title" }}</h5>
          <p class="text-muted mb-4">{{ T "newsletter_description" }}</p>
          
          <form id="newsletter-form" class="newsletter-form">
            <div class="input-group mb-3">
              <input 
                type="email" 
                class="form-control" 
                id="newsletter-email" 
                name="email" 
                placeholder="{{ T "newsletter_email_placeholder" }}" 
                required
                aria-label="{{ T "newsletter_email_placeholder" }}"
              >
              <button 
                class="btn btn-weebi-primary" 
                type="button" 
                id="newsletter-submit"
                aria-label="{{ T "newsletter_subscribe_button" }}"
              >
                <span class="submit-text">{{ T "newsletter_subscribe_button" }}</span>
                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
              </button>
            </div>
            
            <div id="newsletter-message" class="alert d-none" role="alert"></div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('newsletter-form');
  const emailInput = document.getElementById('newsletter-email');
  const submitButton = document.getElementById('newsletter-submit');
  const messageDiv = document.getElementById('newsletter-message');
  
  if (!form || !emailInput || !submitButton || !messageDiv) {
    console.error('Newsletter form elements not found');
    return;
  }
  
  const submitText = submitButton.querySelector('.submit-text');
  const spinner = submitButton.querySelector('.spinner-border');
  
  // API URL - production (GitHub Pages)
  const apiBaseURL = 'https://express.prd.weebi.com';
  const category = '{{ $category }}';
  
  // Debug: log the API URL being used
  console.log('Newsletter API URL:', apiBaseURL);
  
  function showMessage(message, type) {
    messageDiv.textContent = message;
    messageDiv.className = 'alert alert-' + type;
    messageDiv.classList.remove('d-none');
    messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    
    if (type === 'success') {
      setTimeout(function() {
        messageDiv.classList.add('d-none');
      }, 5000);
    }
  }
  
  function setLoading(loading) {
    if (loading) {
      submitButton.disabled = true;
      if (submitText) submitText.classList.add('d-none');
      if (spinner) spinner.classList.remove('d-none');
    } else {
      submitButton.disabled = false;
      if (submitText) submitText.classList.remove('d-none');
      if (spinner) spinner.classList.add('d-none');
    }
  }
  
  function validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
  }
  
  async function handleSubmit() {
    const email = emailInput.value.trim();
    
    if (!email) {
      showMessage('{{ T "newsletter_error_email_required" }}', 'danger');
      return;
    }
    
    if (!validateEmail(email)) {
      showMessage('{{ T "newsletter_error_email_invalid" }}', 'danger');
      return;
    }
    
    setLoading(true);
    messageDiv.classList.add('d-none');
    
    try {
      const encodedEmail = encodeURIComponent(email);
      const encodedCategory = encodeURIComponent(category);
      const url = apiBaseURL + '/api/v1/subscribe/' + encodedEmail + '/' + encodedCategory;
      
      console.log('Fetching URL:', url);
      
      const response = await fetch(url, {
        method: 'POST',
        mode: 'cors',
        headers: {
          'Content-Type': 'application/json',
        },
      });
      
      let data;
      const responseText = await response.text();
      try {
        data = JSON.parse(responseText);
      } catch (e) {
        throw new Error('Invalid response: ' + responseText);
      }
      
      if (response.ok) {
        showMessage('{{ T "newsletter_success" }}', 'success');
        emailInput.value = '';
      } else {
        if (response.status === 409) {
          showMessage('{{ T "newsletter_error_already_subscribed" }}', 'warning');
        } else {
          const errorMsg = (data && (data.message || data.error)) || '{{ T "newsletter_error_generic" }}';
          showMessage(errorMsg, 'danger');
        }
      }
    } catch (error) {
      console.error('Newsletter subscription error:', error);
      showMessage('{{ T "newsletter_error_network" }}', 'danger');
    } finally {
      setLoading(false);
    }
  }
  
  // Use button click instead of form submit to avoid any form submission issues
  submitButton.addEventListener('click', function(e) {
    e.preventDefault();
    handleSubmit();
  });
  
  // Also handle form submit as backup
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    handleSubmit();
  });
});
</script>

<style>
.newsletter-card {
  background-color: #f8f9fa;
  border: 1px solid #e9ecef;
}

.newsletter-form .input-group .form-control {
  border-right: none;
}

.newsletter-form .input-group .btn {
  border-left: none;
  white-space: nowrap;
  margin-left: 0.5rem;
}

.btn-weebi-primary {
  background-color: #046DB5;
  color: white;
  border-color: #046DB5;
}

.btn-weebi-primary:hover {
  background-color: #035a94;
  border-color: #035a94;
  color: white;
}

.btn-weebi-primary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.newsletter-subscription {
  background-color: #ffffff;
}

@media (max-width: 768px) {
  .newsletter-form .input-group {
    flex-direction: column;
  }
  
  .newsletter-form .input-group .form-control {
    border-right: 1px solid #ced4da;
    border-bottom: none;
    border-radius: 0.375rem 0.375rem 0 0;
    margin-bottom: 0;
  }
  
  .newsletter-form .input-group .btn {
    border-left: 1px solid #ced4da;
    border-radius: 0 0 0.375rem 0.375rem;
    width: 100%;
    margin-left: 0;
    margin-top: 0.5rem;
  }
}
</style>
